#ifndef MOVINGAVERAGEINTERFACE
#define MOVINGAVERAGEINTERFACE




struct stateMA { 
  unsigned int sizeinbytes;
  unsigned int code;
  SinglePoint *o_t; // o_t = 1/n Sum_{j=t-N}^y x_j
  SinglePoint *e_t; // e_t = 1/n Sum_{j=t-N}^y |o_j-x_j|
  Mat gamma;
  CircularBuffer *x; // x_{t-N} ... x_{t}
  CircularBuffer *e; // o_{t-N} ... x_{t} 
};

typedef struct stateMA MovingAverageState;

#define ALLOCATE_MA_STATE(f,N,k) {					\
    (f) = (MovingAverageState *) calloc(1,sizeof(MovingAverageState));	\
    assert(f);		    					        \
    ALLOCATESP((f)->o_t,k); ALLOCATESP((f)->e_t);                       \
    if (N>0) { ALLOCATECIRCULAR((f)->x,N,k);} else (f)->x=0;		\
    if (N>0) { ALLOCATECIRCULAR((f)->e,N,k);} else (f)->e=0;		\
  } 



#define FREE_MA_STATE(f) {						\
    if (f) {								\
      if (f->x) {							\
        FREECIRCULAR((f)->x);						\
        FREECIRCULAR((f)->e);						\
      }									\
      FREESP((f)->o_t); FREESP((f)->e_t);                               \
      free(f); (f)=0;							\
    }									\
  } 


#define PRINTMASTATE(t,i)         free(PrintMAState(t,i,1))


#ifndef MOVINGAVERAGE_MODULE

#if defined(c_plusplus) || defined(__cplusplus)
extern "C" {
#endif

  extern int MovingAverage(TimeSeries *stream,
			   MovingAverageState **state,
			   TimeSeries **ytmOut,
			   TimeSeries **dtmOut,
			   int P,
			   Mat gamma
			   );
  
  // these are for serialization and printing 
  extern char * PrintMAState(MovingAverageState *t, int identation, int P);
  extern MovingAverageState * ReadMAState(int identation, char **temp);

#if defined(c_plusplus) || defined(__cplusplus)
}
#endif


#endif





#endif
